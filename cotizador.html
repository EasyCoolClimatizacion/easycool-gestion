<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EasyCool App v8.8.4 Manager</title>
    
    <!-- CONFIGURACI√ìN DE ICONO (APP NATIVA) -->
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/1830/1830182.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1830/1830182.png">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1f2937">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; padding-bottom: 80px; }
        [contenteditable="true"]:hover { outline: 2px dashed #a5b4fc; }
        [contenteditable="true"]:focus { outline: 2px solid #6366f1; background-color: #eef2ff; border-radius: 4px; padding: 4px; }
        .input-mobile { font-size: 16px; }
        .calculator-section { background: linear-gradient(145deg, #f9fafb, #f3f4f6); }
        .modal { transition: opacity 0.25s ease; z-index: 50; }
        .modal-content { transition: transform 0.25s ease; max-height: 90vh; }
        
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 2px; }

        .header-logo-font { font-family: 'Poppins', sans-serif; }
        .header-contact-font { font-family: 'Inter', sans-serif; }
        
        .bottom-nav-item { flex: 1; text-align: center; padding: 10px; color: #9ca3af; transition: all 0.2s; }
        .bottom-nav-item.active { color: #4f46e5; border-top: 3px solid #4f46e5; }

        .delete-row-btn {
            color: #ef4444;
            cursor: pointer;
            padding: 0 8px;
            font-size: 18px;
            opacity: 0.3;
            transition: opacity 0.2s;
        }
        .delete-row-btn:hover { opacity: 1; }
        
        @media print {
            body { background: white; padding: 0; margin: 0; }
            .no-print { display: none !important; }
            .printable-section { 
                width: 100% !important; 
                max-width: 100% !important; 
                box-shadow: none !important; 
                margin: 0 !important; 
                padding: 15mm !important; 
            }
            header { margin-bottom: 5mm !important; padding-bottom: 4mm !important; }
            .client-info-box { margin-bottom: 5mm !important; padding: 4mm !important; }
            #items-table th, #items-table td { padding-top: 2mm !important; padding-bottom: 2mm !important; }
            main .mb-8 { margin-bottom: 5mm !important; }
            footer { margin-top: 8mm !important; padding-top: 4mm !important; page-break-inside: avoid; }
            #tech-specs-section { page-break-inside: avoid; margin-top: 5mm !important; }
            .mt-12 { margin-top: 10px !important; }
            .pt-8 { padding-top: 5px !important; }
            [contenteditable="true"]:hover { outline: none; }
            #bottom-nav { display: none !important; }
            .delete-row-btn { display: none !important; }
            a { text-decoration: none; color: inherit; }
        }
    </style>
</head>
<body class="bg-gray-100 sm:p-8">

    <!-- VISTA 1: CALCULADORA -->
    <div id="view-calculator" class="view-section max-w-4xl mx-auto bg-white p-4 sm:p-6 rounded-xl shadow-lg no-print calculator-section min-h-screen sm:min-h-0">
        
        <!-- HEADER APP -->
        <div class="flex justify-between items-center mb-4 sticky top-0 bg-white z-10 py-3 border-b border-gray-100 shadow-sm -mx-4 px-4 rounded-t-xl">
             <div class="flex items-center gap-3 flex-1">
                 <div class="w-10 h-10 flex-shrink-0 flex items-center justify-center"> 
                     <svg width="100%" height="100%" viewBox="0 0 50 50" fill="none">
                        <rect y="10" width="40" height="7" rx="3.5" fill="#4285F4" opacity="0.9"/>
                        <rect x="5" y="20" width="35" height="7" rx="3.5" fill="#7baaf7" opacity="0.9"/>
                        <rect x="10" y="30" width="30" height="7" rx="3.5" fill="#acd0fc"/>
                    </svg>
                 </div>
                 <div class="flex flex-col justify-center h-10">
                     <span class="text-lg font-bold text-gray-800 leading-none header-logo-font tracking-wide mt-1">EASYCOOL</span>
                     <span class="text-[10px] text-gray-500 font-normal leading-tight header-logo-font">Climatizaci√≥n</span>
                 </div>
             </div>
             <button id="open-price-editor-btn" class="bg-gray-50 text-gray-500 p-2 rounded-full hover:bg-gray-100 border border-gray-200 shadow-sm transition-all active:scale-95 flex items-center justify-center w-10 h-10">
               <i class="fas fa-cog text-lg"></i>
            </button>
        </div>
        
        <div class="grid gap-4">
            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                <div class="space-y-3">
                    <div class="flex justify-between items-start gap-2">
                        <div class="flex-1">
                            <input type="text" id="calc-client-name" placeholder="Nombre Cliente" class="input-mobile border-b border-gray-300 p-2 w-full focus:border-indigo-600 outline-none font-bold text-lg">
                        </div>
                        <div class="w-24 bg-gray-50 p-1 rounded border border-gray-200 text-center">
                            <label class="block text-[9px] text-gray-500 font-bold uppercase">Folio</label>
                            <div class="flex items-center justify-center">
                                <span class="text-xs text-gray-400 mr-1">#</span>
                                <input type="number" id="calc-folio-number" class="input-mobile bg-transparent w-full text-center font-bold text-indigo-600 outline-none p-0" value="45">
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <input type="text" id="calc-client-rut" placeholder="RUT" class="input-mobile border border-gray-200 p-2 rounded w-1/3 text-sm">
                        <input type="text" id="calc-client-address" placeholder="Direcci√≥n" class="input-mobile border border-gray-200 p-2 rounded w-2/3 text-sm">
                    </div>
                </div>
            </div>

            <details class="bg-white p-3 rounded-xl border border-gray-200 group">
                <summary class="flex justify-between items-center font-bold text-gray-700 cursor-pointer list-none text-sm">
                    <span class="flex items-center gap-2"><i class="fas fa-calculator text-orange-500"></i> Calculadora BTU</span>
                    <i class="fas fa-chevron-down text-gray-400 group-open:rotate-180 transition-transform"></i>
                </summary>
                <div class="mt-3 flex gap-2">
                    <input type="number" id="ancho-mts" placeholder="Ancho" class="border p-2 rounded w-1/2 text-center text-sm">
                    <input type="number" id="largo-mts" placeholder="Largo" class="border p-2 rounded w-1/2 text-center text-sm">
                    <button id="calculate-btu-btn" class="bg-orange-100 text-orange-600 px-3 py-2 rounded-lg font-bold text-xs">Calc</button>
                </div>
                <p id="btu-result" class="text-center text-xs font-bold text-indigo-600 h-4 mt-2"></p>
                <div class="hidden"><input id="alto-mts" value="2.4"><input id="numero-ventanas" value="1"><input id="numero-personas" value="2"><select id="exposicion-solar"><option value="mucha">Sol</option></select></div>
            </details>

            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                <h3 class="text-sm font-bold text-gray-700 mb-2">Equipos de Aire Acondicionado</h3>
                <div id="equipos-container" class="space-y-3 mb-3"></div>
                <button id="add-equipo-btn" class="w-full py-3 rounded-lg border-2 border-dashed border-indigo-200 text-indigo-500 font-bold text-sm hover:bg-indigo-50 transition-colors">+ Agregar Equipo a Cotizaci√≥n</button>
            </div>

            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                <h3 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                    <i class="fas fa-tools text-gray-500"></i> Materiales e Insumos
                </h3>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div><label class="block text-xs text-gray-500 mb-1">Soportes</label><input type="number" id="qty-soporte" class="material-input input-mobile border border-gray-300 rounded p-2 w-full text-center font-semibold" value="1"></div>
                    <div><label class="block text-xs text-gray-500 mb-1">Cord√≥n (m)</label><input type="number" id="qty-cordon" class="material-input input-mobile border border-gray-300 rounded p-2 w-full text-center font-semibold" value="3"></div>
                    <div><label class="block text-xs text-gray-500 mb-1">Canaleta 100</label><input type="number" id="qty-canaleta-1" class="material-input input-mobile border border-gray-300 rounded p-2 w-full text-center font-semibold" value="1"></div>
                    <div><label class="block text-xs text-gray-500 mb-1">Canaleta 20</label><input type="number" id="qty-canaleta-2" class="material-input input-mobile border border-gray-300 rounded p-2 w-full text-center font-semibold" value="1"></div>
                    <div><label class="block text-xs text-gray-500 mb-1 font-bold text-blue-600">Tuber√≠a (m)</label><input type="number" id="qty-tuberia" class="material-input input-mobile border border-blue-200 rounded p-2 w-full text-center font-semibold text-blue-700 bg-blue-50" value="0"></div>
                    <div><label class="block text-xs text-gray-500 mb-1 font-bold text-blue-600">Bomba</label><input type="number" id="qty-bomba" class="material-input input-mobile border border-blue-200 rounded p-2 w-full text-center font-semibold text-blue-700 bg-blue-50" value="0"></div>
                </div>
                <div class="hidden">
                    <input id="costo-soporte" value="7500">
                    <input id="costo-canaleta-1" value="5950">
                    <input id="costo-canaleta-2" value="1210">
                    <input id="costo-cordon" value="917">
                    <input id="costo-bomba" value="45000">
                    <input id="costo-tuberia" value="15000">
                </div>
            </div>

            <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                <div class="flex justify-between items-center mb-3">
                    <label class="text-xs font-bold text-indigo-900">Mano de Obra (x Equipo)</label>
                    <div class="flex items-center bg-white border border-indigo-200 rounded px-2">
                        <span class="text-gray-500 text-xs">$</span>
                        <input type="number" id="costo-mano-obra" class="input-mobile w-24 text-right p-2 font-bold outline-none text-indigo-900" value="120000">
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs font-bold text-gray-500">Costos Adicionales / Vi√°ticos</label>
                        <button id="add-extra-btn" class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-200 transition">+ Agregar Item Extra</button>
                    </div>
                    <div id="extras-container" class="space-y-2"></div>
                </div>
                
                <div class="flex justify-between items-center bg-white p-2 rounded border border-gray-300 mt-3">
                    <label class="text-xs font-bold text-gray-700">Margen Materiales %</label>
                    <input type="number" id="margen-ganancia" class="input-mobile w-16 text-center font-bold text-green-600 outline-none border-b border-green-200" value="30">
                </div>
            </div>

            <div class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700 text-white mb-2">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 border-b border-gray-700 pb-1">Desglose Financiero Real (Privado)</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-700/50 p-2 rounded border border-gray-600">
                        <p class="text-[9px] text-green-400 uppercase font-bold mb-1">üí∞ Total a Cobrar</p>
                        <p id="live-total-cobrar" class="text-lg font-mono font-bold text-white">$ 0</p>
                        <p class="text-[8px] text-gray-400">(Bruto con IVA)</p>
                    </div>
                    <div class="bg-gray-700/50 p-2 rounded border border-gray-600">
                        <p class="text-[9px] text-red-300 uppercase font-bold mb-1">üõí Pagar Proveedores</p>
                        <p id="live-pago-proveedores" class="text-lg font-mono font-bold text-white">$ 0</p>
                        <p class="text-[8px] text-gray-400 font-bold text-yellow-300">(IVA Incluido)</p>
                    </div>

                    <div class="bg-gray-700/50 p-2 rounded border border-gray-600">
                        <p class="text-[9px] text-yellow-300 uppercase font-bold mb-1 border-b border-gray-600 pb-1">üèõÔ∏è Detalle IVA (F29)</p>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[8px] text-gray-400">Venta (+):</span>
                            <span id="live-iva-venta" class="text-[9px] font-mono text-green-300">$ 0</span>
                        </div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[8px] text-gray-400">Compra (-):</span>
                            <span id="live-iva-compra" class="text-[9px] font-mono text-red-300">$ 0</span>
                        </div>
                        <div class="border-t border-gray-600 pt-1 mt-1 flex justify-between items-center">
                            <span class="text-[8px] text-yellow-200 font-bold">A PAGAR:</span>
                            <span id="live-pago-iva" class="text-sm font-mono font-bold text-yellow-400">$ 0</span>
                        </div>
                    </div>
                    <div class="bg-green-900/40 p-2 rounded border border-green-600">
                        <p class="text-[9px] text-green-300 uppercase font-bold mb-1">üíµ Tu Ganancia L√≠quida</p>
                        <p id="live-utilidad" class="text-xl font-mono font-bold text-green-400">$ 0</p>
                        <p class="text-[8px] text-green-200">(Libre en el Bolsillo)</p>
                    </div>
                </div>
                <button id="update-stats-btn" class="mt-3 w-full text-xs text-gray-400 hover:text-white underline">Actualizar C√°lculos</button>
            </div>
        </div>
        
        <div class="h-24"></div>
        <div class="fixed bottom-[60px] left-0 right-0 p-4 z-40 bg-gradient-to-t from-white via-white to-transparent">
            <button id="generate-quote-btn" class="w-full bg-gray-900 text-white font-bold py-4 rounded-xl shadow-2xl text-lg flex items-center justify-center gap-2 hover:bg-black transition-colors">
                Generar Cotizaci√≥n <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- VISTA 2: HISTORIAL -->
    <div id="view-history" class="view-section max-w-4xl mx-auto bg-white p-4 rounded-xl shadow-lg no-print min-h-screen hidden">
        <h2 class="text-2xl font-bold text-gray-900 mb-4 px-2">Historial</h2>
        <div id="history-list" class="space-y-3 pb-20">
            <div class="text-center text-gray-400 mt-10"><i class="fas fa-history text-4xl mb-2"></i><p>No hay cotizaciones guardadas a√∫n.</p></div>
        </div>
    </div>

    <!-- BARRA DE NAVEGACI√ìN -->
    <div id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around z-50 no-print pb-safe">
        <div class="bottom-nav-item active cursor-pointer" onclick="switchTab('calculator')"><i class="fas fa-calculator text-xl mb-1 block"></i><span class="text-[10px] font-bold uppercase">Cotizar</span></div>
        <div class="bottom-nav-item cursor-pointer" onclick="switchTab('history')"><i class="fas fa-clock text-xl mb-1 block"></i><span class="text-[10px] font-bold uppercase">Historial</span></div>
    </div>

    <!-- VISTA 3: COTIZACI√ìN (PDF) -->
    <div id="quote-section" class="max-w-4xl mx-auto bg-white p-10 shadow-2xl printable-section hidden">
        <header class="flex justify-between items-start pb-6 border-b border-gray-100 mb-8">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 flex-shrink-0">
                    <svg width="100%" height="100%" viewBox="0 0 50 50" fill="none">
                        <rect y="10" width="40" height="7" rx="3.5" fill="#4285F4" opacity="0.9"/><rect x="5" y="20" width="35" height="7" rx="3.5" fill="#7baaf7" opacity="0.9"/><rect x="10" y="30" width="30" height="7" rx="3.5" fill="#acd0fc"/>
                    </svg>
                </div>
                <div class="flex flex-col justify-center">
                    <span class="text-xl font-bold text-gray-800 leading-none header-logo-font tracking-wide">EASYCOOL</span>
                    <span class="text-xs text-gray-500 font-normal leading-tight header-logo-font">Climatizaci√≥n</span>
                </div>
            </div>
            <div class="text-right header-contact-font" contenteditable="true">
                <h1 class="text-lg font-bold text-gray-800 mb-1">EasyCool Climatizaci√≥n</h1>
                <p class="text-xs text-gray-500 leading-snug">RUT: 77.448.234-2</p>
                <p class="text-xs text-gray-500 leading-snug">Providencia, Santiago</p>
                <p class="text-xs text-gray-500 leading-snug">ventas@easycoolclimatizacion.com</p>
                <p class="text-xs text-gray-500 leading-snug">+569 5777 6174 / +569 4489 4101</p>
            </div>
        </header>
        
        <div class="bg-gray-50 p-6 rounded-lg mb-8 border border-gray-100 flex justify-between items-start header-contact-font client-info-box">
            <div class="w-2/3">
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">CLIENTE</p>
                <p contenteditable="true" class="text-lg font-bold text-gray-900" id="client-name"></p>
                <p contenteditable="true" class="text-sm text-gray-600 mt-1" id="client-rut"></p>
                <p contenteditable="true" class="text-sm text-gray-600" id="client-address"></p>
            </div>
            <div class="w-1/3 text-right">
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">COTIZACI√ìN</p>
                <p class="text-sm font-bold text-gray-900" id="quote-number" contenteditable="true"></p>
                <p class="text-sm text-gray-600" id="current-date" contenteditable="true"></p>
            </div>
        </div>

        <main>
             <div class="mb-8">
                <table class="w-full text-left border-collapse" id="items-table">
                    <thead>
                        <tr class="border-b border-gray-200">
                            <th class="py-3 pl-2 w-8 no-print"></th>
                            <th class="py-3 text-xs font-bold text-gray-500 uppercase tracking-wider pl-2">Descripci√≥n</th>
                            <th class="py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider w-32 pr-2">Total Neto</th>
                        </tr>
                    </thead>
                    <tbody class="text-sm text-gray-700"></tbody>
                </table>
            </div>

            <div class="flex justify-end pt-4">
                <div class="w-1/2 md:w-1/3 space-y-2 text-right">
                    <div class="flex justify-between text-sm py-1"><span class="text-gray-500">Subtotal Neto:</span><span id="subtotal" class="font-medium text-gray-800" contenteditable="true"></span></div>
                    <div class="flex justify-between text-sm py-1"><span class="text-gray-500">IVA (19%):</span><span id="iva" class="font-medium text-gray-800" contenteditable="true"></span></div>
                    <div class="flex justify-between items-center text-xl font-bold text-indigo-900 mt-3 pt-3 border-t-2 border-indigo-100">
                        <span>TOTAL:</span>
                        <span id="total" contenteditable="true"></span>
                    </div>
                </div>
            </div>

             <div id="tech-specs-section" class="mt-10 bg-blue-50 p-5 rounded-lg border border-blue-100" style="display:none;">
                <h4 class="text-xs font-bold text-blue-800 uppercase tracking-wider mb-2 flex items-center gap-2"><i class="fas fa-info-circle"></i> Especificaciones T√©cnicas</h4>
                <div id="tech-specs-content" class="text-xs text-blue-900 space-y-1" contenteditable="true"></div>
            </div>

             <div class="mt-8 pt-6 border-t border-gray-200">
                <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Condiciones del Servicio</h4>
                <ul contenteditable="true" class="text-xs text-gray-500 list-disc list-inside space-y-1 header-contact-font">
                    <li><strong>Forma de Pago:</strong> 50% para agendar y materiales, 50% al finalizar conforme.</li>
                    <li><strong>Garant√≠a:</strong> 1 a√±o por instalaci√≥n (fugas, drenaje). Equipos seg√∫n fabricante.</li>
                    <li><strong>Validez:</strong> La oferta es v√°lida por 10 d√≠as h√°biles.</li>
                </ul>
            </div>
        </main>
        
        <footer class="text-center mt-12 pt-8 border-t border-gray-100">
            <div class="mb-4">
                <p class="text-xs font-bold text-indigo-600 mb-1">¬°S√≠guenos en Instagram para ver nuestras instalaciones!</p>
                <a href="https://instagram.com/easycool_climatizacion" target="_blank" class="text-sm font-bold text-gray-800 flex justify-center items-center gap-2 hover:text-pink-600 transition-colors cursor-pointer" style="text-decoration: none;">
                    <i class="fab fa-instagram text-pink-600 text-lg"></i> @easycool_climatizacion
                </a>
            </div>
            <p class="text-[10px] text-gray-300 font-bold uppercase tracking-widest mt-4">EasyCool Climatizaci√≥n - Santiago, Chile</p>
        </footer>
    </div>

    <!-- ACCIONES PDF -->
    <div id="print-action-bar" class="fixed bottom-0 left-0 right-0 p-4 bg-white border-t z-50 hidden flex flex-col gap-3 no-print shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
        <div class="flex gap-2">
            <button id="wa-btn" class="flex-1 bg-green-500 text-white font-bold py-3 rounded-xl shadow flex items-center justify-center gap-2 text-sm"><i class="fab fa-whatsapp text-lg"></i> Enviar WhatsApp</button>
            <button id="print-btn" class="flex-1 bg-gray-900 text-white font-bold py-3 rounded-xl shadow flex items-center justify-center gap-2 text-sm"><i class="fas fa-file-pdf text-lg"></i> Guardar PDF</button>
        </div>
        <button id="back-to-edit-btn" class="text-gray-400 text-xs font-bold py-2 uppercase tracking-wider">Volver a Editar</button>
    </div>

    <!-- MODAL GESTI√ìN DE EQUIPOS Y PRECIOS -->
    <div id="price-editor-modal" class="modal fixed inset-0 z-50 flex items-end justify-center bg-black bg-opacity-60 hidden opacity-0 no-print">
        <div class="modal-content bg-white w-full rounded-t-2xl p-6 h-[85vh] flex flex-col">
            <div class="flex justify-between border-b pb-3 mb-4"><h3 class="font-bold">Gesti√≥n de Equipos y Costos</h3><button id="close-modal-btn" class="text-2xl text-gray-500">&times;</button></div>
            
            <div class="overflow-y-auto custom-scroll flex-1 pr-1">
                <h4 class="text-xs font-bold text-gray-400 uppercase mb-2">Costos Unitarios Materiales</h4>
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div><label class="text-xs text-gray-500">Soporte</label><input type="number" id="modal-costo-soporte" class="border w-full text-right p-1 rounded"></div>
                    <div><label class="text-xs text-gray-500">Canaleta 100</label><input type="number" id="modal-costo-canaleta-1" class="border w-full text-right p-1 rounded"></div>
                    <div><label class="text-xs text-gray-500">Canaleta 20</label><input type="number" id="modal-costo-canaleta-2" class="border w-full text-right p-1 rounded"></div>
                    <div><label class="text-xs text-gray-500">Cord√≥n</label><input type="number" id="modal-costo-cordon" class="border w-full text-right p-1 rounded"></div>
                    <div><label class="text-xs text-gray-500">Bomba</label><input type="number" id="modal-costo-bomba" class="border w-full text-right p-1 rounded"></div>
                    <div><label class="text-xs text-gray-500">Tuber√≠a</label><input type="number" id="modal-costo-tuberia" class="border w-full text-right p-1 rounded"></div>
                    <div class="col-span-2 bg-indigo-50 p-2 rounded border border-indigo-100"><label class="text-xs font-bold text-indigo-900">Mano de Obra Base (Costo)</label><input type="number" id="modal-costo-mano-obra" class="border w-full text-right p-1 rounded font-bold text-indigo-900"></div>
                </div>

                <h4 class="text-xs font-bold text-gray-400 uppercase mb-2 sticky top-0 bg-white py-1 z-10">Lista de Equipos</h4>
                <div id="equipment-price-editor" class="space-y-2 mb-4"></div>

                <div class="bg-green-50 p-3 rounded-lg border border-green-200 mb-4">
                    <h5 class="text-[10px] font-bold uppercase text-green-700 mb-2"><i class="fas fa-plus-circle"></i> Agregar Nuevo Equipo</h5>
                    <div class="flex flex-col gap-2">
                        <input id="new-eq-name" type="text" placeholder="Nombre (ej: Midea Xtreme 9.000)" class="text-xs border border-green-200 p-2 rounded w-full focus:outline-none focus:border-green-500">
                        <div class="flex gap-2">
                            <input id="new-eq-price" type="number" placeholder="Costo Neto" class="text-xs border border-green-200 p-2 rounded w-full focus:outline-none focus:border-green-500">
                            <button id="add-new-eq-btn" class="bg-green-600 text-white px-4 rounded font-bold text-lg shadow-sm hover:bg-green-700">+</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pt-4 border-t mt-2">
                <button id="save-prices-btn" class="w-full bg-gray-900 text-white py-3 rounded-lg font-bold">Guardar Todo y Cerrar</button>
            </div>
        </div>
    </div>

<script>
let lastQuoteData = {};
let specs = new Set(); 

const defaultEquiposDB = {
    'hisense-9': { nombre: 'Hisense Hi-Vida 9.000 BTU', costo: 215990, specs: ['Inverter', 'WiFi'] },
    'hisense-12': { nombre: 'Hisense Hi-Vida 12.000 BTU', costo: 243990, specs: ['Inverter', 'WiFi'] },
    'hisense-18': { nombre: 'Hisense Hi-Vida 18.000 BTU', costo: 353990, specs: ['Inverter', 'WiFi'] },
    'hisense-22': { nombre: 'Hisense Hi-Vida 22.000 BTU', costo: 387990, specs: ['Inverter', 'WiFi'] },
    'hisense-pro-12': { nombre: 'Hisense Pro X 12.000 (Black)', costo: 255900, specs: ['Premium Black'] },
    'daikin-al-9': { nombre: 'Daikin AL 9.000 BTU', costo: 189990, specs: ['Japon√©s', 'Silencioso'] },
    'daikin-al-12': { nombre: 'Daikin AL 12.000 BTU', costo: 209900, specs: ['Japon√©s', 'Silencioso'] },
    'daikin-al-18': { nombre: 'Daikin AL 18.000 BTU', costo: 379900, specs: ['Japon√©s', 'Silencioso'] },
    'daikin-al-24': { nombre: 'Daikin AL 24.000 BTU', costo: 499900, specs: ['Japon√©s', 'Silencioso'] },
    'otro': { nombre: 'Otro (Manual)', costo: 0, specs: [] }
};

let equiposDB = { ...defaultEquiposDB };
const MATERIAL_KEYS = ['soporte','canaleta-1','canaleta-2','cordon','bomba','tuberia','mano-obra'];

function saveCustomPrices() {
    const customData = { equipos: equiposDB, materiales: {} };
    MATERIAL_KEYS.forEach(key => {
        const el = document.getElementById(`costo-${key}`);
        if (el) customData.materiales[key] = parseFloat(el.value) || 0;
    });
    localStorage.setItem('easycool_db_v3', JSON.stringify(customData));
}

function loadCustomPrices() {
    const saved = localStorage.getItem('easycool_db_v3');
    if(saved) {
        try {
            const data = JSON.parse(saved);
            if(data.equipos) equiposDB = data.equipos;
            if(data.materiales) {
                Object.keys(data.materiales).forEach(k => {
                    const el = document.getElementById(`costo-${k}`);
                    if(el) el.value = data.materiales[k];
                });
            }
        } catch(e) { console.error("Error cargando DB", e); }
    }
}

function addNewEquipment() {
    const name = document.getElementById('new-eq-name').value;
    const price = parseInt(document.getElementById('new-eq-price').value);
    if(!name || isNaN(price)) { alert("Ingresa nombre y precio v√°lido."); return; }
    const key = 'custom-' + Date.now();
    equiposDB[key] = { nombre: name, costo: price, specs: ['Personalizado'] };
    document.getElementById('new-eq-name').value = '';
    document.getElementById('new-eq-price').value = '';
    saveCustomPrices();
    renderModalItems();
    updateAllDropdowns();
}

window.deleteEquipment = (key) => {
    if(confirm(`¬øELIMINAR "${equiposDB[key].nombre}"?`)) {
        delete equiposDB[key];
        saveCustomPrices();
        renderModalItems();
        updateAllDropdowns();
    }
};

function renderModalItems() {
    const container = document.getElementById('equipment-price-editor');
    container.innerHTML = '';
    Object.keys(equiposDB).forEach(k => {
        if(k !== 'otro') {
            const eq = equiposDB[k];
            const div = document.createElement('div');
            div.className = "flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-100 gap-2";
            div.innerHTML = `
                <button onclick="deleteEquipment('${k}')" class="text-gray-300 hover:text-red-500 transition-colors px-2"><i class="fas fa-trash"></i></button>
                <div class="flex-1 overflow-hidden"><p class="text-xs font-bold text-gray-700 truncate">${eq.nombre}</p></div>
                <div class="flex items-center gap-1"><span class="text-xs text-gray-400">$</span><input type="number" value="${eq.costo}" class="border rounded p-1 text-right w-20 text-xs font-mono" onchange="updateEquipmentCost('${k}', this.value)"></div>
            `;
            container.appendChild(div);
        }
    });
}

window.updateEquipmentCost = (key, val) => { if(equiposDB[key]) equiposDB[key].costo = parseFloat(val) || 0; };

function updateAllDropdowns() {
    const selects = document.querySelectorAll('.eq-sel');
    selects.forEach(sel => {
        const currentVal = sel.value;
        sel.innerHTML = Object.keys(equiposDB).map(k => `<option value="${k}">${equiposDB[k].nombre}</option>`).join('');
        if(equiposDB[currentVal]) sel.value = currentVal; else sel.value = Object.keys(equiposDB)[0];
    });
    calculateFinances();
}

window.switchTab = (tab) => {
    document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
    document.querySelectorAll('.bottom-nav-item').forEach(el => el.classList.remove('active'));
    if(tab === 'calculator') { document.getElementById('view-calculator').classList.remove('hidden'); document.querySelectorAll('.bottom-nav-item')[0].classList.add('active'); }
    else if(tab === 'history') { document.getElementById('view-history').classList.remove('hidden'); document.querySelectorAll('.bottom-nav-item')[1].classList.add('active'); renderHistory(); }
};

function saveToHistory(quoteData) {
    let history = JSON.parse(localStorage.getItem('easycool_history') || '[]');
    history.unshift(quoteData); if(history.length > 20) history.pop();
    localStorage.setItem('easycool_history', JSON.stringify(history));
}

function renderHistory() {
    const list = document.getElementById('history-list');
    const history = JSON.parse(localStorage.getItem('easycool_history') || '[]');
    if(history.length === 0) { list.innerHTML = `<div class="text-center text-gray-400 mt-10"><i class="fas fa-history text-4xl mb-2"></i><p>Sin historial.</p></div>`; return; }
    list.innerHTML = history.map((q, index) => `
        <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 flex justify-between items-center mb-2" onclick="loadFromHistory(${index})">
            <div><p class="font-bold text-gray-800">${q.clientName}</p><p class="text-xs text-gray-500">${q.date} - ${q.quoteID}</p></div>
            <div class="text-right"><p class="font-bold text-gray-900">${q.total}</p><button class="text-xs text-blue-500 mt-1">Ver <i class="fas fa-chevron-right"></i></button></div>
        </div>
    `).join('');
}

window.loadFromHistory = (index) => {
    const history = JSON.parse(localStorage.getItem('easycool_history') || '[]');
    const q = history[index]; if(!q) return;
    document.getElementById('calc-client-name').value = q.clientName;
    document.getElementById('client-name').textContent = q.clientName;
    document.getElementById('client-rut').textContent = q.clientRut;
    document.getElementById('client-address').textContent = q.clientAddress;
    document.getElementById('quote-number').textContent = q.quoteID;
    document.getElementById('current-date').textContent = q.date;
    document.getElementById('items-table').querySelector('tbody').innerHTML = q.itemsHtml;
    document.getElementById('subtotal').textContent = q.subtotal;
    document.getElementById('iva').textContent = q.iva;
    document.getElementById('total').textContent = q.total;
    document.getElementById('tech-specs-content').innerHTML = q.specsHtml;
    if(q.specsHtml) document.getElementById('tech-specs-section').style.display = 'block';
    lastQuoteData = q.meta;
    document.getElementById('view-calculator').classList.add('hidden');
    document.getElementById('quote-section').classList.remove('hidden');
    document.getElementById('print-action-bar').classList.remove('hidden');
    document.getElementById('bottom-nav').classList.add('hidden');
    window.scrollTo(0,0);
};

function calculateFinances() {
    const getEl = (id) => document.getElementById(id);
    let totalEq = 0, totalQtyEquipos = 0;
    specs = new Set();
    document.querySelectorAll('.equipo-item').forEach(row => {
        const k = row.querySelector('.eq-sel').value;
        const q = parseFloat(row.querySelector('.eq-qty').value)||0;
        totalQtyEquipos += q;
        if(equiposDB[k]) {
            const c = (k==='otro') ? parseFloat(row.querySelector('.eq-cost').value)||0 : equiposDB[k].costo;
            totalEq += q*c;
            if(k!=='otro') specs.add(k);
        }
    });
    const getVal = (id) => parseFloat(getEl(id)?.value) || 0;
    const totalMatBase = (getVal('qty-soporte') * getVal('costo-soporte')) + (getVal('qty-canaleta-1') * getVal('costo-canaleta-1')) + (getVal('qty-canaleta-2') * getVal('costo-canaleta-2')) + (getVal('qty-cordon') * getVal('costo-cordon'));
    const qtyBomba = getVal('qty-bomba'), costoBombaTotal = qtyBomba * getVal('costo-bomba');
    const qtyTuberia = getVal('qty-tuberia'), costoTuberiaTotal = qtyTuberia * getVal('costo-tuberia');
    const margen = getVal('margen-ganancia')/100;
    const ventaEqBaseMat = (totalEq + totalMatBase) * (1 + margen);
    const ventaBomba = costoBombaTotal * (1 + margen), ventaTuberia = costoTuberiaTotal * (1 + margen);
    const totalMO = getVal('costo-mano-obra') * totalQtyEquipos;
    let extrasCosto = 0; const extrasList = [];
    document.querySelectorAll('.extra-item').forEach(row => {
        const desc = row.querySelector('.extra-desc').value || 'Extra', cost = parseFloat(row.querySelector('.extra-cost').value) || 0;
        if(cost > 0) { extrasCosto += cost; extrasList.push({ description: desc, price: cost }); }
    });
    const neto = ventaEqBaseMat + ventaBomba + ventaTuberia + totalMO + extrasCosto;
    const ivaVenta = neto * 0.19, totalCobrar = neto + ivaVenta;
    const costosProveedoresNeto = totalEq + totalMatBase + costoBombaTotal + costoTuberiaTotal + extrasCosto;
    const ivaCompra = costosProveedoresNeto * 0.19;
    const utilidadLiquida = neto - costosProveedoresNeto;

    if(getEl('live-total-cobrar')) getEl('live-total-cobrar').textContent = "$ " + Math.round(totalCobrar).toLocaleString('es-CL');
    if(getEl('live-pago-proveedores')) getEl('live-pago-proveedores').textContent = "$ " + Math.round(costosProveedoresNeto * 1.19).toLocaleString('es-CL');
    if(getEl('live-iva-venta')) getEl('live-iva-venta').textContent = "$ " + Math.round(ivaVenta).toLocaleString('es-CL');
    if(getEl('live-iva-compra')) getEl('live-iva-compra').textContent = "$ " + Math.round(ivaCompra).toLocaleString('es-CL');
    if(getEl('live-pago-iva')) getEl('live-pago-iva').textContent = "$ " + Math.round(ivaVenta - ivaCompra).toLocaleString('es-CL');
    if(getEl('live-utilidad')) getEl('live-utilidad').textContent = "$ " + Math.round(utilidadLiquida).toLocaleString('es-CL');

    return { ventaEqBaseMat, ventaBomba, ventaTuberia, qtyBomba, qtyTuberia, totalMO, extrasList, neto, iva: ivaVenta, total: totalCobrar };
}

function recalculateQuoteTotals() {
    const rows = document.querySelectorAll('#items-table tbody tr');
    let subtotal = 0;
    rows.forEach(row => {
        const priceText = row.children[row.children.length - 1].textContent;
        const price = parseInt(priceText.replace(/[^0-9]/g, '')) || 0;
        subtotal += price;
    });
    const iva = Math.round(subtotal * 0.19);
    const total = subtotal + iva;
    document.getElementById('subtotal').textContent = "$ " + subtotal.toLocaleString('es-CL');
    document.getElementById('iva').textContent = "$ " + iva.toLocaleString('es-CL');
    document.getElementById('total').textContent = "$ " + total.toLocaleString('es-CL');
}

document.addEventListener('DOMContentLoaded', () => {
    const dom = {
        calcBtn: document.getElementById('calculate-btu-btn'), btuRes: document.getElementById('btu-result'),
        eqContainer: document.getElementById('equipos-container'), extrasContainer: document.getElementById('extras-container'),
        addEqBtn: document.getElementById('add-equipo-btn'), addExtraBtn: document.getElementById('add-extra-btn'),
        genQuoteBtn: document.getElementById('generate-quote-btn'), printBtn: document.getElementById('print-btn'),
        waBtn: document.getElementById('wa-btn'), modal: document.getElementById('price-editor-modal'),
        openModalBtn: document.getElementById('open-price-editor-btn'), closeModalBtn: document.getElementById('close-modal-btn'),
        savePricesBtn: document.getElementById('save-prices-btn'), addNewEqBtn: document.getElementById('add-new-eq-btn'),
        backBtn: document.getElementById('back-to-edit-btn'), updateStatsBtn: document.getElementById('update-stats-btn')
    };

    loadCustomPrices();
    document.querySelector('#items-table tbody').addEventListener('click', (e) => {
        const btn = e.target.closest('.delete-row-btn');
        if (btn) { btn.closest('tr').remove(); recalculateQuoteTotals(); }
    });
    document.querySelector('#items-table').addEventListener('input', (e) => { if (e.target.tagName === 'TD') recalculateQuoteTotals(); });

    dom.calcBtn.addEventListener('click', () => {
        const v = (parseFloat(document.getElementById('ancho-mts').value)||0)*(parseFloat(document.getElementById('largo-mts').value)||0)*2.4;
        dom.btuRes.textContent = `Sugerido: ~${Math.round((v*250+1000)/1000)*1000} BTU`;
    });

    function addRow() {
        const div = document.createElement('div');
        div.className = 'equipo-item flex gap-2 items-center bg-gray-50 p-2 rounded-lg border border-gray-100';
        div.innerHTML = `<select class="eq-sel border border-gray-300 rounded p-2 text-sm flex-1 bg-white">${Object.keys(equiposDB).map(k=>`<option value="${k}">${equiposDB[k].nombre}</option>`).join('')}</select><input type="number" class="eq-qty border border-gray-300 rounded p-2 text-sm w-12 text-center bg-white" value="1"><input type="number" class="eq-cost border border-gray-300 rounded p-2 text-sm flex-1 bg-white hidden" placeholder="Costo"><button class="rm-btn text-red-500 px-2 font-bold">&times;</button>`;
        dom.eqContainer.appendChild(div);
        const sel = div.querySelector('.eq-sel'), cost = div.querySelector('.eq-cost');
        const updateRow = () => { 
            if(equiposDB[sel.value]) {
                cost.value = equiposDB[sel.value].costo; 
                if(sel.value==='otro') cost.classList.remove('hidden'); else cost.classList.add('hidden'); 
                calculateFinances(); 
            }
        };
        sel.addEventListener('change', updateRow);
        cost.addEventListener('input', calculateFinances);
        div.querySelector('.rm-btn').addEventListener('click', () => { if(dom.eqContainer.children.length>1) div.remove(); calculateFinances(); });
        div.querySelector('.eq-qty').addEventListener('input', calculateFinances);
        sel.value = Object.keys(equiposDB)[0]; updateRow();
    }
    dom.addEqBtn.addEventListener('click', addRow); addRow();

    function addExtraRow() {
        const div = document.createElement('div');
        div.className = 'extra-item flex gap-2 items-center mb-2';
        div.innerHTML = `<input type="text" class="extra-desc border border-gray-300 rounded p-2 text-xs flex-1 outline-none" placeholder="Descripci√≥n"><div class="flex items-center bg-white border border-gray-300 rounded px-2 w-24"><span class="text-gray-500 text-xs">$</span><input type="number" class="extra-cost input-mobile w-full text-right p-1 outline-none text-xs" value="0"></div><button class="rm-extra-btn text-red-400 hover:text-red-600"><i class="fas fa-times"></i></button>`;
        dom.extrasContainer.appendChild(div);
        div.querySelector('.extra-desc').addEventListener('input', calculateFinances);
        div.querySelector('.extra-cost').addEventListener('input', calculateFinances);
        div.querySelector('.rm-extra-btn').addEventListener('click', () => { div.remove(); calculateFinances(); });
    }
    dom.addExtraBtn.addEventListener('click', addExtraRow);

    dom.genQuoteBtn.addEventListener('click', () => {
        if(!document.getElementById('calc-client-name').value) return document.getElementById('calc-client-name').focus();
        const clientName = document.getElementById('calc-client-name').value, clientRut = document.getElementById('calc-client-rut').value, clientAddr = document.getElementById('calc-client-address').value;
        const dateStr = new Date().toLocaleDateString('es-CL'), now = new Date();
        const folioInput = document.getElementById('calc-folio-number');
        let folioNum = parseInt(folioInput.value) || 0;
        const quoteID = `EC-${now.getFullYear()}-${String(folioNum).padStart(3, '0')}`;
        document.getElementById('client-name').textContent = clientName;
        document.getElementById('client-rut').textContent = clientRut;
        document.getElementById('client-address').textContent = clientAddr;
        document.getElementById('quote-number').textContent = quoteID;
        document.getElementById('current-date').textContent = dateStr;
        const fin = calculateFinances();
        let itemsHtml = '', equiposDescriptions = [], mainEq = '';
        document.querySelectorAll('.equipo-item').forEach((row, idx) => {
            const k = row.querySelector('.eq-sel').value, q = parseFloat(row.querySelector('.eq-qty').value)||0;
            if(equiposDB[k]) { equiposDescriptions.push(`${q}x ${equiposDB[k].nombre}`); if (idx === 0) mainEq = equiposDB[k].nombre; }
        });
        const delBtnHtml = '<td class="no-print text-center"><span class="delete-row-btn"><i class="fas fa-times-circle"></i></span></td>';
        itemsHtml += `<tr>${delBtnHtml}<td class="py-2 pl-2 border-b border-gray-100 align-top" contenteditable="true"><p class="font-bold text-gray-800">Suministro de Equipos y Materiales</p><div class="text-xs text-gray-500 mt-1 pl-2 border-l-2 border-indigo-100">${equiposDescriptions.join('<br>')}<br>+ Kit de materiales e insumos de instalaci√≥n</div></td><td class="py-2 pr-2 text-right border-b border-gray-100 align-top font-semibold text-gray-700" contenteditable="true">$ ${Math.round(fin.ventaEqBaseMat).toLocaleString('es-CL')}</td></tr>`;
        if (fin.qtyBomba > 0) itemsHtml += `<tr>${delBtnHtml}<td class="py-2 pl-2 border-b border-gray-100 align-top" contenteditable="true"><p class="font-bold text-gray-800">Suministro de Bomba de Condensado (${fin.qtyBomba} un)</p></td><td class="py-2 pr-2 text-right border-b border-gray-100 align-top font-semibold text-gray-700" contenteditable="true">$ ${Math.round(fin.ventaBomba).toLocaleString('es-CL')}</td></tr>`;
        if (fin.qtyTuberia > 0) itemsHtml += `<tr>${delBtnHtml}<td class="py-2 pl-2 border-b border-gray-100 align-top" contenteditable="true"><p class="font-bold text-gray-800">Suministro de Tuber√≠a de Refrigeraci√≥n (${fin.qtyTuberia} mts)</p></td><td class="py-2 pr-2 text-right border-b border-gray-100 align-top font-semibold text-gray-700" contenteditable="true">$ ${Math.round(fin.ventaTuberia).toLocaleString('es-CL')}</td></tr>`;
        const tbody = document.querySelector('#items-table tbody'); tbody.innerHTML = itemsHtml;
        tbody.innerHTML += `<tr>${delBtnHtml}<td class="py-2 pl-2 border-b border-gray-100" contenteditable="true"><p class="font-bold text-gray-800">Servicio de Instalaci√≥n Profesional</p><p class="text-xs text-gray-500">Mano de obra certificada, vac√≠o t√©cnico y puesta en marcha.</p></td><td class="py-2 pr-2 text-right border-b border-gray-100 align-top font-semibold text-gray-700" contenteditable="true">$ ${Math.round(fin.totalMO).toLocaleString('es-CL')}</td></tr>`;
        fin.extrasList.forEach(ext => { tbody.innerHTML += `<tr>${delBtnHtml}<td class="py-2 pl-2 text-xs text-gray-600" contenteditable="true">${ext.description}</td><td class="py-2 pr-2 text-right font-semibold text-gray-700" contenteditable="true">$ ${Math.round(ext.price).toLocaleString('es-CL')}</td></tr>`; });
        const specBox = document.getElementById('tech-specs-content'); specBox.innerHTML = '';
        let specsHtml = ''; if(specs.size > 0) { document.getElementById('tech-specs-section').style.display = 'block'; specs.forEach(k => { if(equiposDB[k].specs) { const s = `<p><strong>${equiposDB[k].nombre}:</strong> ${equiposDB[k].specs.join(', ')}.</p>`; specBox.innerHTML += s; specsHtml += s; } }); }
        const totalStr = "$ " + Math.round(fin.total).toLocaleString('es-CL');
        document.getElementById('subtotal').textContent = "$ " + Math.round(fin.neto).toLocaleString('es-CL');
        document.getElementById('iva').textContent = "$ " + Math.round(fin.iva).toLocaleString('es-CL');
        document.getElementById('total').textContent = totalStr;
        lastQuoteData = { equipoNombres: Array.from(specs).map(k=>equiposDB[k].nombre).join(', '), totalFormateado: totalStr, mainEquipment: mainEq };
        saveToHistory({ quoteID, clientName, clientRut, clientAddress: clientAddr, date: dateStr, total: totalStr, subtotal: document.getElementById('subtotal').textContent, iva: document.getElementById('iva').textContent, itemsHtml: tbody.innerHTML, specsHtml, mainEq, meta: lastQuoteData });
        document.getElementById('view-calculator').classList.add('hidden');
        document.getElementById('quote-section').classList.remove('hidden');
        document.getElementById('print-action-bar').classList.remove('hidden');
        document.getElementById('bottom-nav').classList.add('hidden');
        window.scrollTo(0,0);
    });

    dom.backBtn.addEventListener('click', () => {
        document.getElementById('view-calculator').classList.remove('hidden');
        document.getElementById('quote-section').classList.add('hidden');
        document.getElementById('print-action-bar').classList.add('hidden');
        document.getElementById('bottom-nav').classList.remove('hidden');
    });

    dom.waBtn.addEventListener('click', () => {
        const text = `Hola ${document.getElementById('client-name').textContent}, te env√≠o la cotizaci√≥n EasyCool para ${lastQuoteData.equipoNombres}. Total: ${lastQuoteData.totalFormateado}. Incluye instalaci√≥n profesional y garant√≠a.`;
        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
    });

    dom.printBtn.addEventListener('click', () => {
        document.title = `Cotizaci√≥n_${document.getElementById('quote-number').textContent}`;
        window.print();
    });

    dom.openModalBtn.addEventListener('click', () => {
        dom.modal.classList.remove('hidden', 'opacity-0');
        renderModalItems();
        MATERIAL_KEYS.forEach(id => { const el = document.getElementById(`modal-costo-${id}`); if(el) el.value = document.getElementById(`costo-${id}`).value; });
    });
    dom.closeModalBtn.addEventListener('click', () => dom.modal.classList.add('hidden', 'opacity-0'));
    dom.addNewEqBtn.addEventListener('click', addNewEquipment);
    dom.savePricesBtn.addEventListener('click', () => {
        MATERIAL_KEYS.forEach(id => { const el = document.getElementById(`modal-costo-${id}`); if(el) document.getElementById(`costo-${id}`).value = el.value; });
        saveCustomPrices(); updateAllDropdowns(); dom.modal.classList.add('hidden', 'opacity-0'); calculateFinances();
    });
    calculateFinances();
});
</script>
</body>
</html>
